<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Review Registrations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/review_vendors.css') }}">
</head>
<body>
  <div class="dashboard-container">
    <h2>Review Registrations</h2>

    <div class="filter-buttons">
      <button class="btn-all" onclick="filterVendors('all')">All (<span id="count-all">0</span>)</button>
      <button class="btn-approved" onclick="filterVendors('approved')">Approved (<span id="count-approved">{{ counts['approved'] }}</span>)</button>
      <button class="btn-pending" onclick="filterVendors('pending')">Pending (<span id="count-pending">{{ counts['pending'] }}</span>)</button>
      <button class="btn-onhold" onclick="filterVendors('hold')">On Hold (<span id="count-hold">{{ counts['hold'] }}</span>)</button>
      <button class="btn-rejected" onclick="filterVendors('rejected')">Rejected (<span id="count-rejected">{{ counts['rejected'] }}</span>)</button>
    </div>

    <table id="vendorTable">
      <thead>
        <tr>
          <th>Company</th>
          <th>Email</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for v in vendors %}
        <tr data-id="{{ v['id'] }}" data-status="{{ v['status']|lower }}">
          <td>{{ v['company_name'] }}</td>
          <td>{{ v['email'] }}</td>
          <td>{{ v['status'] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="vendor-details" id="vendorDetails" style="display: none;">
      <div class="vendor-card">
        <h3>Vendor Details</h3>

        <div class="vendor-section">
          <p><strong>Company:</strong> <span id="detail-company"></span></p>
          <p><strong>Email:</strong> <span id="detail-email"></span></p>
          <p><strong>Phone:</strong> <span id="detail-phone"></span></p>
          <p><strong>GST Number:</strong> <span id="detail-gst"></span></p>
          <p><strong>TAN Number:</strong> <span id="detail-tan"></span></p>
          <p><strong>Registered Address:</strong> <span id="detail-registered-address"></span></p>
          <p><strong>Branch Addresses:</strong> <span id="detail-branch-addresses"></span></p>
          <p><strong>Products/Services:</strong> <span id="detail-products"></span></p>
          <p><strong>Status:</strong> <span class="status-badge" id="detail-status"></span></p>
        </div>

        <div id="soleSection" class="vendor-section" style="display:none;">
          <h4>Sole Proprietor</h4>
          <p><strong>Name:</strong> <span id="detail-owner-name"></span></p>
          <p><strong>Email:</strong> <span id="detail-owner-email"></span></p>
          <p><strong>Phone:</strong> <span id="detail-owner-phone"></span></p>
          <p><strong>PAN:</strong> <span id="detail-owner-pan"></span></p>
        </div>

        <div id="partnerSection" class="vendor-section" style="display:none;">
          <h4>Partners</h4>
          <ul id="partnerList"></ul>
        </div>

        <div id="directorSection" class="vendor-section" style="display:none;">
          <h4>Directors</h4>
          <ul id="directorList"></ul>
        </div>

        ${data.status === 'approved' ? '' : `
          <div class="vendor-actions">
            <button class="btn-approve" onclick="updateStatus('approved')">Approve</button>
            <button class="btn-hold" onclick="updateStatus('hold')">Hold</button>
            <button class="btn-reject" onclick="updateStatus('rejected')">Reject</button>
          </div>
        `}
      </div>

    </div>


    <br>
    <div class="back-link-wrapper">
      <a href="{{ url_for('admin_dashboard') }}">â¬… Back to Dashboard</a>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
 <script>
  $(document).ready(function () {
    $('#vendorTable').DataTable();
    updateCounts();
  });

  function filterVendors(status) {
    $('#vendorTable tbody tr').each(function () {
      const rowStatus = $(this).data('status');
      $(this).toggle(status === 'all' || rowStatus === status);
    });
  }

  $('#vendorTable').on('click', 'tr', function () {
    const vendorId = $(this).data('id');
    $('#vendorDetails').hide().html('<p style="padding:10px;">Loading...</p>');

    $.get(`/admin/vendor-details/${vendorId}`, function (data) {
      let actionButtons = '';
      if (data.status !== 'approved' && data.status !== 'rejected') {
        actionButtons = `
          <div class="vendor-actions">
            <button class="btn-approve" onclick="updateStatus('approved')">Approve</button>
            <button class="btn-hold" onclick="updateStatus('hold')">Hold</button>
            <button class="btn-reject" onclick="updateStatus('rejected')">Reject</button>
          </div>
        `;
      }

      $('#vendorDetails').html(`
        <h3>Vendor Details</h3>
        <p><strong>Company:</strong> <span id="detail-company">${data.company_name}</span></p>
        <p><strong>Email:</strong> <span id="detail-email">${data.email}</span></p>
        <p><strong>Phone:</strong> <span id="detail-phone">${data.phone}</span></p>
        <p><strong>GST Number:</strong> <span id="detail-gst">${data.gst_number}</span></p>
        <p><strong>TAN Number:</strong> <span id="detail-tan">${data.tan_number}</span></p>
        <p><strong>Registered Address:</strong> <span id="detail-registered-address">${data.registered_address}</span></p>
        <p><strong>Branch Addresses:</strong> <span id="detail-branch-addresses">${data.branch_addresses}</span></p>
        <p><strong>Products/Services:</strong> <span id="detail-products">${data.product_services}</span></p>
        <p><strong>Status:</strong> <span id="detail-status">${data.status}</span></p>

        <div id="soleSection" style="display:none;">
          <h4>Sole Proprietor</h4>
          <p><strong>Name:</strong> <span id="detail-owner-name"></span></p>
          <p><strong>Email:</strong> <span id="detail-owner-email"></span></p>
          <p><strong>Phone:</strong> <span id="detail-owner-phone"></span></p>
          <p><strong>PAN:</strong> <span id="detail-owner-pan"></span></p>
        </div>

        <div id="partnerSection" style="display:none;">
          <h4>Partners</h4>
          <ul id="partnerList"></ul>
        </div>

        <div id="directorSection" style="display:none;">
          <h4>Directors</h4>
          <ul id="directorList"></ul>
        </div>

        ${actionButtons}
      `);

      $('#vendorDetails').data('vendor-id', vendorId);

      // Display ownership-specific section
      $('#soleSection, #partnerSection, #directorSection').hide();
      const ownership = (data.ownership_type || '').toLowerCase();
      if (ownership === 'sole') {
        $('#detail-owner-name').text(data.owner_name);
        $('#detail-owner-email').text(data.owner_email);
        $('#detail-owner-phone').text(data.owner_phone);
        $('#detail-owner-pan').text(data.owner_pan);
        $('#soleSection').show();
      } else if (ownership === 'partnership' || ownership === 'llp') {
        const list = $('#partnerList').empty();
        (data.partners || []).forEach(p => {
          list.append(`<li>${p.name} (${p.email}) - ${p.phone}</li>`);
        });
        $('#partnerSection').show();
      } else if (ownership === 'pvtltd' || ownership === 'publicltd') {
        const list = $('#directorList').empty();
        (data.directors || []).forEach(d => {
          list.append(`<li>${d.name} (${d.email}) - ${d.phone}</li>`);
        });
        $('#directorSection').show();
      }

      $('#vendorDetails').show();
    });
  });

  function updateStatus(newStatus) {
    const vendorId = $('#vendorDetails').data('vendor-id');
    const row = $(`#vendorTable tbody tr[data-id="${vendorId}"]`);

    $.ajax({
      url: '/admin/update-vendor-status',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ id: vendorId, status: newStatus }),
      success: function (res) {
        alert(res.message);
        row.find('td:nth-child(3)').text(newStatus);
        row.attr('data-status', newStatus.toLowerCase());
        $('#detail-status').text(newStatus);
        updateCounts();
        $('#vendorDetails').hide(); // optionally hide the detail panel after update
      },
      error: function (xhr) {
        alert("Error updating status: " + xhr.responseJSON.message);
      }
    });
  }

  function updateCounts() {
    const counts = { all: 0, approved: 0, pending: 0, hold: 0, rejected: 0 };
    $('#vendorTable tbody tr').each(function () {
      const status = $(this).data('status');
      if (counts[status] !== undefined) counts[status]++;
      counts.all++;
    });
    for (const key in counts) {
      $('#count-' + key).text(counts[key]);
    }
  }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - Review Invoices</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_invoices.css') }}">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>
<body>
  <div class="dashboard-container">
    <h2>Uploaded Invoices</h2>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Vendor</th>
            <th>File</th>
            <th>Status</th>
            <th>Uploaded At</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr id="invoice-{{ invoice.id }}">
            <td>{{ invoice.company_name }}</td>
            <td>
                <a href="{{ invoice.file_url }}" target="_blank">{{ invoice.file_name }}</a>
            </td>
            <td class="status">
              <span class="status-badge status-{{ invoice.status | lower | replace(' ', '-') }}">
                {{ invoice.status or 'Pending' }}
              </span>
            </td>

            <td>{{ invoice.uploaded_at }}</td>
            <td>
              {% if invoice.status.lower() not in ['approved', 'rejected'] %}
                <button class="btn-approve" onclick="updateStatus('{{ invoice.id }}', 'Approved')">Approve</button>
                <button class="btn-reject" onclick="updateStatus('{{ invoice.id }}', 'Rejected')">Reject</button>
              {% else %}
                <span class="locked-status">Finalized</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="back-link-wrapper">
      <a id="back-link-wrapper" href="{{ url_for('admin_dashboard') }}">â¬… Back to Dashboard</a>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    $(document).ready(function() {
      $('table').DataTable({
        pageLength: 10,
        order: [[3, "desc"]], // Default sort by Uploaded At
        columnDefs: [
          { orderable: false, targets: 4 } // Disable sorting on Action column
        ]
      });
    });

  function updateStatus(invoiceId, newStatus) {
      console.log("Sending request for invoice", invoiceId, "new status:", newStatus);

      fetch(`/admin/invoice/status/${invoiceId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error("Server returned " + response.status);
        }
        return response.json();
      })
      .then(data => {
        console.log("Response:", data);
        if (data.success) {
          alert(`Status updated to ${newStatus}`);
          window.location.reload();
        } else {
          alert(data.message || "Failed to update status");
        }
      })
      .catch(error => {
        console.error("Error updating status:", error);
        alert("Failed to update status: " + error.message);
      });
    }
</script>
</body>
</html>


